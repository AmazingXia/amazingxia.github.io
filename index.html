<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>guba</title>
  <style>
    html {
      height: 100%;
      overflow: hidden;
      line-height: 1.15;
      /* 1 */
      -webkit-text-size-adjust: 100%;
      /* 2 */
    }

    body {
      overflow: hidden;
      margin: 0;
      height: 100%;
      padding: 20px;
    }

    input {
      height: 42px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0 10px;
      font-size: 16px;
      width: 300px;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <input type="text" id="code" placeholder="请输入查询内容" />

  <script>
    document.getElementById("code").addEventListener("change", function (e) {
      handleRequest(e.target.value);
    });
    async function handleRequest(code) {
      const days = 5;
      try {
        const res = await calcCount(code, days);
        res.str = Object.keys(res.info).map((key) => `${key}: ${res.info[key]}`).join("\n");
        console.log('res===>', res);
      } catch (error) {
        console.log('error===>', error);
      }
    }

    // 计算某股票过去 `days` 天的帖子数量
    async function calcCount(code, days = 5) {
      let page = 1;
      const res = {
        info: {},
      };
      const targetDay = new Date();
      targetDay.setDate(targetDay.getDate() - days);
      const targetDateStr = targetDay.toISOString().slice(0, 10).replace(/-/g, ""); // 格式化 YYYYMMDD

      while (true) {
        const { list, bar_info } = await getGubaCount(code, page++);
        if (!list || list.length === 0) break; // 没有数据就停止

        if (!res.bar_info) {
          res.bar_info = bar_info
        }

        for (const item of list) {
          const postDay = new Date(item.post_last_time).toISOString().slice(0, 10).replace(/-/g, "");

          if (postDay <= targetDateStr) {
            return res; // 如果已经到目标日期，直接返回结果
          }

          res.info[postDay] = (res.info[postDay] || 0) + 1;
        }
      }
      return res;
    }
    // 获取股票帖子数据
    async function getGubaCount(code = "301366", page = 1) {
      const curl = `curl https://gbapi.eastmoney.com/webarticlelist/api/Article/WebArticleList?code=${code}&p=${page}&ps=500&sorttype=0&plat=wap&version=300&product=guba&deviceid=1`;

      const postData = {
        curl: curl
      };

      const response = await fetch('https://capis-ecs.didapinche.com/web/webtool/bfs/bigfile/curl', {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(postData)
      });

      if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

      const data = await response.json();
      return {
        list: data.re || [],
        bar_info: {
          OuterCode: data.bar_info?.OuterCode || "",
          ShowCode: data.bar_info?.ShowCode || "",
          ShortName: data.bar_info?.ShortName || "",
        }
      };
    }

  </script>



</body>

</html>